# CLAUDE.md

## Mission

Server‑first theme designer for VS Code and shadcn/ui. Published themes live in the URL (Nuqs). The live editor runs on Zustand. Tailwind 4 drives styling.

## Stack

- Next 14 with React Server Components, runtime Bun.
- Supabase for data. Row‑level security on. Drizzle supplies schema and migrations only.
- State split: Nuqs for shareable URL params, Zustand for local/editor/global UI.
- Tailwind 4: every `--color‑*` token usable via `bg-*`, `text-*`, `border-*`.

## Architectural rules

1. Default to server components. Mark a file `"use client"` only when the browser owns the logic.
2. Keep client files ≤150 LOC and ≤10 cyclomatic complexity.
3. Avoid `useEffect` and `useState`. Prefer server actions, URL params, or Zustand hooks.
4. One concern per component, hook, or file.
5. No bespoke CSS unless theming the code‑editor iframe.

## State layers

| Concern                                  | Store   | Persistence            | Shareable | Strategy |
| ---------------------------------------- | ------- | ---------------------- | --------- | -------- |
| Published theme parameters               | Nuqs    | URL                    | Yes       | Server-parsed, client-reactive |
| Search params (q, filters, modals)      | Nuqs    | URL                    | Yes       | Server-parsed, client-reactive |
| Live editor buffer, undo/redo, UI panels | Zustand | localStorage (persist) | No        | Client-only |
| Auth, user preferences                   | Zustand | memory/localStorage    | No        | Client-only |
| Toast queue, modal toggles               | Zustand | memory                 | No        | Client-only |

## Nuqs strategy

- **Server-first approach**: Parse search params server-side using `createSearchParamsCache()`.
- **Shared parsers**: Define parsers in `lib/search-params.ts`, used by both server cache and client `useQueryStates`.
- **No client-side filtering**: Server components handle all search/filter logic. Client only manages URL updates.
- Use flat, kebab‑case param names. Nest only via JSON string when unavoidable.
- On "Share", sync Zustand → Nuqs. On load, hydrate Zustand from Nuqs.

## Zustand pattern (sketch)

```
import { create } from 'zustand'
import { persist } from 'zustand/middleware'

export const useThemeStore = create(
  persist((set) => ({
    colors: {},
    setColor: (k,v) => set(s => ({ ...s, colors: { ...s.colors, [k]: v } }))
  }), { name: 'tinte-editor-v1' })
)
```

Never mutate the URL inside Zustand actions—call a helper that updates Nuqs instead.

## Data layer

- `createServerSupabaseClient()` for authenticated server queries (injects Clerk token).
- `createPublicServerSupabaseClient()` for anonymous read‑only queries.
- Edge runtime: payload ≤1 MB; avoid `select('*')` in hot paths.

## Drizzle workflow

1. Edit `lib/db/schema.ts`.
2. Run `bun run db:generate` to update types.
3. Run `bun run db:migrate` to push SQL. No other commands.

## Error handling and toasts

Every server action returns `{ ok: true, data }` or `{ ok: false, message }`. Client utility `handleResult()` shows a shadcn toast on failure. Throw only when an invariant truly fails; otherwise `try/catch` and return an error object.

## Tailwind color tokens

Primary palette is injected under `:root` at build time. Use Tailwind variable syntax (`bg-[var(--color-primary)]`, etc.). No hard‑coded hex values outside the live preview.

## Auth rules

Clerk supplies JWT. Supabase RLS enforces `user_id = auth.uid()` for non‑public rows. Back‑end always overwrites `userId` from Clerk on inserts.

## Claude usage policy

Allowed tools: `Edit`, `Bash(bun run db:*)`, `Bash(git *)`, `gh`, `mcp__puppeteer__*`, `mcp__supabase__*`, `Search`.
Denied by default: destructive commands, `bun run build`, `bun run dev`.
Workflow:

1. Claude thinks, proposes a plan.
2. Human reviews.
3. Claude codes, commits, opens PR.
4. A second Claude reviews if the diff exceeds 50 LOC in any client component.
   Use `/clear` between unrelated tasks.

## Commit and branch convention

Branches: `feat/<slug>`, `fix/<slug>`, `chore/<slug>`.
Commits generated by Claude use Conventional Commits. Include `#issue` when relevant.

## Logging

Logging not yet integrated. Until a solution is chosen, keep logs server‑side only.

## Slash commands

`.claude/commands/` holds reusable prompts. Examples: `publish-theme.md` (sync Nuqs ↔ DB, generate OG image), `fix-lint.md` (run bun run lint, commit).

## Code hygiene checklist (Claude must confirm before PR merge)

- No client component imports server utilities.
- No `any` types introduced.
- All colors reference CSS variables.
- New DB fields include migration and updated Drizzle types.
- Bundle diff ≤ +5 kB unless flagged.

End of file. Keep under 300 lines and update as standards evolve.
